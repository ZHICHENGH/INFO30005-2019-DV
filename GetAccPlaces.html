<!DOCTYPE html >
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lykmapipo/themify-icons@0.1.2/css/themify-icons.css">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Digital Vibe</title>
    <meta name="description" content="Digital Vibe">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */

        #search {
            width:30%;
            height:90px;
        }

        #PlaceDetails {
            width:30%;
            margin:90px;
            float:left;
        }

        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<html>
<body>
<div id="search">
    <input id="pac-input" type="text" placeholder="Place name or address">

    <button class="btn search-btn" type="submit"><i class="fa fa-search"></i></button>
    <p>Toilet <input type="checkbox" id="Acc_Toilet_Check" onclick="initMap()">
        Carpark <input type="checkbox" id="Acc_Carpark_Check" onclick="initMap()">
        Lift <input type="checkbox" id="Acc_Lift_Check" onclick="initMap()">
    </p>
</div>

<div id="PlaceDetails"></div>

<div style="height: 100%" id="map"></div>

<script>
    var markers = [];
    var markers2 = [];

    function initMap() {
        var bounds = new google.maps.LatLngBounds();

        var map = new google.maps.Map(document.getElementById('map'), {
            center: new google.maps.LatLng(-37.7963689, 144.9589798),
            zoom: 16
        });

        /*
        map.addListener('click', function(e) {
            var exist = false;
            var latLng2 = e.latLng;

            if (exist == false) {
                placeMarkerAndPanTo(e.latLng, map);
            }
        });
        */

        function placeMarkerAndPanTo(latLng, map) {
            deleteMarkers();

            var marker = new google.maps.Marker({
                position: latLng,
                map: map
            });
            map.panTo(latLng);

            var infoWindow = new google.maps.InfoWindow({
                content: 'Latitude: ' + latLng.lat() + '<br />Longitude: ' + latLng.lng()
            });
            infoWindow.open(map, marker);

            markers.push(marker);
        }

        function deleteMarkers() {
            // Clear out the old markers.
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
        }

        deleteMarkers();
        $.getJSON('https://joyaccess.herokuapp.com/places/placeAPI', function(jsonData) {
            $.each(jsonData, function(key,data) {
                var place_name = data.place_name;
                var address = data.address;
                var acc_toilet = data.acc_toilet;
                var acc_carpark = data.acc_carpark;
                var acc_lift = data.acc_lift;
                var point = new google.maps.LatLng(
                    parseFloat(data.lat),
                    parseFloat(data.lng));

                console.log("place_name = " + place_name + "\naddress = " + address + "\nacc_toilet = " + acc_toilet +
                    "\nacc_carpark = " + acc_carpark + "\nacc_lift = " + acc_lift + "\npoint = " + point + "\nToilet Check = " +
                    document.getElementById("Acc_Toilet_Check").checked + "\nCarpark Check = " + document.getElementById("Acc_Carpark_Check").checked +
                    "\nLift Check = " + document.getElementById("Acc_Lift_Check").checked);

                if ((document.getElementById("Acc_Toilet_Check").checked == true && acc_toilet == true) ||
                (document.getElementById("Acc_Carpark_Check").checked == true && acc_carpark == true) ||
                (document.getElementById("Acc_Lift_Check").checked == true && acc_lift == true)) {
                    console.log("Found place with accessibility!");
                    var infowincontent = document.createElement('div');
                    var strong = document.createElement('strong');
                    strong.textContent = place_name;
                    infowincontent.appendChild(strong);
                    infowincontent.appendChild(document.createElement('br'));

                    var text = document.createElement('text');
                    text.textContent = address;
                    infowincontent.appendChild(text);

                    if (acc_toilet == true){
                        var acctext_toilet = document.createElement('text');
                        infowincontent.appendChild(document.createElement('br'));
                        acctext_toilet.textContent = "Accessible Toilet";
                        infowincontent.appendChild(acctext_toilet);
                    }
                    if (acc_carpark == true){
                        var acctext_carpark = document.createElement('text');
                        infowincontent.appendChild(document.createElement('br'));
                        acctext_carpark.textContent = "Accessible Carpark";
                        infowincontent.appendChild(acctext_carpark);
                    }
                    if (acc_lift == true){
                        var acctext_lift = document.createElement('text');
                        infowincontent.appendChild(document.createElement('br'));
                        acctext_lift.textContent = "Accessible Lift";
                        infowincontent.appendChild(acctext_lift);
                    }

                    //var icon = customLabel[type] || {};
                    var marker = new google.maps.Marker({
                        title: place_name,
                        address: address,
                        map: map,
                        position: point
                        //label: icon.label
                    });
                    marker.addListener('click', function () {
                        document.getElementById("PlaceDetails").innerHTML = "";
                        document.body.style = "white-space: pre;";
                        var para = document.createElement("p");
                        var node1 = document.createTextNode("Name: " + marker.title + "\n");
                        para.appendChild(node1);
                        var node2 = document.createTextNode("Address: " + marker.address +  "\n");
                        para.appendChild(node2);
                        var node3 = document.createTextNode("Position = " + marker.position + "\n");
                        para.appendChild(node3);

                        var acc_toilet_input = document.createElement('input');
                        acc_toilet_input.type = 'checkbox';
                        acc_toilet_input.id = 'acc_toilet_input';
                        acc_toilet_input.value = "value";
                        acc_toilet_input.class = "chk";
                        // creating label for checkbox
                        var toilet_label = document.createElement('label');
                        // assigning attributes for the created label tag
                        toilet_label.htmlFor = "acc_toilet_input";
                        // appending the created text to the created label tag
                        toilet_label.appendChild(document.createTextNode(' Toilet '));
                        // appending the checkbox and label to div
                        para.appendChild(toilet_label);
                        para.appendChild(acc_toilet_input);

                        var acc_carpark_input = document.createElement('input');
                        acc_carpark_input.type = 'checkbox';
                        acc_carpark_input.id = 'acc_carpark_input';
                        acc_carpark_input.value = "value";
                        acc_carpark_input.class = "chk";
                        // creating label for checkbox
                        var carpark_label = document.createElement('label');
                        // assigning attributes for the created label tag
                        carpark_label.htmlFor = "acc_carpark_input";
                        // appending the created text to the created label tag
                        carpark_label.appendChild(document.createTextNode(' Carpark '));
                        // appending the checkbox and label to div
                        para.appendChild(carpark_label);
                        para.appendChild(acc_carpark_input);

                        var acc_lift_input = document.createElement('input');
                        acc_lift_input.type = 'checkbox';
                        acc_lift_input.id = 'acc_lift_input';
                        acc_lift_input.value = "value";
                        acc_lift_input.class = "chk";
                        // creating label for checkbox
                        var lift_label = document.createElement('label');
                        // assigning attributes for the created label tag
                        lift_label.htmlFor = "acc_lift_input";
                        // appending the created text to the created label tag
                        lift_label.appendChild(document.createTextNode(' Lift '));
                        // appending the checkbox and label to div
                        para.appendChild(lift_label);
                        para.appendChild(acc_lift_input);

                        var element = document.getElementById("PlaceDetails");
                        element.appendChild(para);

                        if (acc_toilet == true) {
                            document.getElementById("acc_toilet_input").checked = true;
                        }
                        if (acc_carpark == true) {
                            document.getElementById("acc_carpark_input").checked = true;
                        }
                        if (acc_lift == true) {
                            document.getElementById("acc_lift_input").checked = true;
                        }

                        var infoWindow = new google.maps.InfoWindow({
                            content: infowincontent
                        });
                        //infoWindow.setContent(infowincontent);
                        infoWindow.open(map, marker);
                    });

                    //extend the bounds to include each marker's position
                    bounds.extend(marker.position);
                    //now fit the map to the newly inclusive bounds
                    map.fitBounds(bounds);
                    map.setZoom(16);

                    markers.push(marker);
                }
            });
        });


        // Create the search box and link it to the UI element.
        var input = document.getElementById('pac-input');
        var searchBox = new google.maps.places.SearchBox(input);
        //map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        // Bias the SearchBox results towards current map's viewport.
        map.addListener('bounds_changed', function() {
            searchBox.setBounds(map.getBounds());
        });

        // Listen for the event fired when the user selects a prediction and retrieve
        // more details for that place.
        searchBox.addListener('places_changed', function() {
            var places = searchBox.getPlaces();

            if (places.length == 0) {
                return;
            }

            // Clear out the old markers.
            markers2.forEach(function(marker2) {
                marker2.setMap(null);
            });
            markers2 = [];
            deleteMarkers();
            document.getElementById("Acc_Toilet_Check").checked = false;
            document.getElementById("Acc_Carpark_Check").checked = false;
            document.getElementById("Acc_Lift_Check").checked = false;

            // For each place, get the icon, name and location.
            var bounds = new google.maps.LatLngBounds();

            places.forEach(function(place) {
                if (!place.geometry) {
                    console.log("Returned place contains no geometry");
                    return;
                }
                var icon = {
                    url: place.icon,
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(20, 20)
                };

                // Create a marker for each place.
                var marker2 = new google.maps.Marker({
                    map: map,
                    icon: icon,
                    title: place.name,
                    position: place.geometry.location,
                    address:place.formatted_address
                });

                var infoWindow2 = new google.maps.InfoWindow();

                google.maps.event.addListener(marker2,'click',(function(marker2, map) {
                    return function () {
                        document.getElementById("PlaceDetails").innerHTML = "";
                        var infowincontent = document.createElement('div');

                        document.body.style = "white-space: pre;";
                        var para = document.createElement("p");
                        var node1 = document.createTextNode("Name: " + marker2.title + "\n");
                        para.appendChild(node1);
                        var node2 = document.createTextNode("Address: " + marker2.address +  "\n");
                        para.appendChild(node2);
                        var node3 = document.createTextNode("Position = " + marker2.position + "\n");
                        para.appendChild(node3);

                        var acc_toilet_input = document.createElement('input');
                        acc_toilet_input.type = 'checkbox';
                        acc_toilet_input.id = 'acc_toilet_input';
                        acc_toilet_input.value = "value";
                        acc_toilet_input.class = "chk";
                        // creating label for checkbox
                        var toilet_label = document.createElement('label');
                        // assigning attributes for the created label tag
                        toilet_label.htmlFor = "acc_toilet_input";
                        // appending the created text to the created label tag
                        toilet_label.appendChild(document.createTextNode(' Toilet '));
                        // appending the checkbox and label to div
                        para.appendChild(toilet_label);
                        para.appendChild(acc_toilet_input);

                        var acc_carpark_input = document.createElement('input');
                        acc_carpark_input.type = 'checkbox';
                        acc_carpark_input.id = 'acc_carpark_input';
                        acc_carpark_input.value = "value";
                        acc_carpark_input.class = "chk";
                        // creating label for checkbox
                        var carpark_label = document.createElement('label');
                        // assigning attributes for the created label tag
                        carpark_label.htmlFor = "acc_carpark_input";
                        // appending the created text to the created label tag
                        carpark_label.appendChild(document.createTextNode(' Carpark '));
                        // appending the checkbox and label to div
                        para.appendChild(carpark_label);
                        para.appendChild(acc_carpark_input);

                        var acc_lift_input = document.createElement('input');
                        acc_lift_input.type = 'checkbox';
                        acc_lift_input.id = 'acc_lift_input';
                        acc_lift_input.value = "value";
                        acc_lift_input.class = "chk";
                        // creating label for checkbox
                        var lift_label = document.createElement('label');
                        // assigning attributes for the created label tag
                        lift_label.htmlFor = "acc_lift_input";
                        // appending the created text to the created label tag
                        lift_label.appendChild(document.createTextNode(' Lift '));
                        // appending the checkbox and label to div
                        para.appendChild(lift_label);
                        para.appendChild(acc_lift_input);

                        var element = document.getElementById("PlaceDetails");
                        element.appendChild(para);

                        var strong = document.createElement('strong');
                        strong.textContent = marker2.title;
                        infowincontent.appendChild(strong);
                        infowincontent.appendChild(document.createElement('br'));

                        var text = document.createElement('text');
                        text.textContent = marker2.address;
                        infowincontent.appendChild(text);

                        $.getJSON('https://joyaccess.herokuapp.com/places/placeAPI', function(jsonData) {
                            $.each(jsonData, function (key, data) {
                                var place_name = data.place_name;
                                var address = data.address;
                                var acc_toilet = data.acc_toilet;
                                var acc_carpark = data.acc_carpark;
                                var acc_lift = data.acc_lift;
                                var lat = parseFloat(data.lat);
                                var lng = parseFloat(data.lng);

                                console.log("place_name = " + place_name + "\naddress = " + address + "\nacc_toilet = " + acc_toilet +
                                    "\nacc_carpark = " + acc_carpark + "\nacc_lift = " + acc_lift + "\npoint lat = " + lat + "\npoint lng = " +
                                        lng + "\nMarker lat = " + marker2.position.lat() + "\nMarker lng = " + marker2.position.lng());

                                // If this Google Map Places API marker corresponds to an existing location in our
                                // database that has accessibility info, we display the accessibility info as well
                                if ((lat == marker2.position.lat() && lng == marker2.position.lng()) &&
                                    ((acc_toilet == true) || (acc_carpark == true) ||
                                    (acc_lift == true))) {
                                    console.log("Matching location found! Accessibility info should be visible!");

                                    if (acc_toilet == true) {
                                        document.getElementById("acc_toilet_input").checked = true;
                                        var acctext_toilet = document.createElement('text');
                                        infowincontent.appendChild(document.createElement('br'));
                                        acctext_toilet.textContent = "Accessible Toilet. ";
                                        infowincontent.appendChild(acctext_toilet);
                                    }

                                    if (acc_carpark == true) {
                                        document.getElementById("acc_carpark_input").checked = true;
                                        var acctext_carpark = document.createElement('text');
                                        infowincontent.appendChild(document.createElement('br'));
                                        acctext_carpark.textContent = "Accessible Carpark. ";
                                        infowincontent.appendChild(acctext_carpark);
                                    }

                                    if (acc_lift == true) {
                                        document.getElementById("acc_lift_input").checked = true;
                                        var acctext_lift = document.createElement('text');
                                        infowincontent.appendChild(document.createElement('br'));
                                        acctext_lift.textContent = "Accessible lift";
                                        infowincontent.appendChild(acctext_lift);
                                    }
                                }
                            });
                        });
                        infoWindow2.setContent(infowincontent);
                        infoWindow2.open(map, marker2);
                    }
                }) (marker2, map, place));

                markers2.push(marker2);

                if (place.geometry.viewport) {
                    // Only geocodes have viewport.
                    bounds.union(place.geometry.viewport);
                } else {
                    bounds.extend(place.geometry.location);
                }
            });
            map.fitBounds(bounds);
        });
    }

</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBamM2AMAzA6-D3sgXjvdoGeLp3_yj0wg0&libraries=places&callback=initMap">
</script>
</body>
</html>